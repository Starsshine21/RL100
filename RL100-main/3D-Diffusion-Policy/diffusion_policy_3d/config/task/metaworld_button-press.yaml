# @package task
# ============================================
# MetaWorld Button Press 任务配置 - 优化版
# ============================================

name: button_press_v2
env_name: button-press-v2

# ============================================
# 1. 形状元数据
# ============================================
shape_meta: &shape_meta
  obs:
    point_cloud:
      shape: [1024, 3]    # 1024个点，XYZ坐标
      type: point_cloud
    agent_pos:
      shape: [9]          # 末端位置(3) + 右指(3) + 左指(3)
      type: low_dim
  action:
    shape: [4]            # MetaWorld动作维度

# ============================================
# 2. 环境Runner（用于评估）
# ============================================
env_runner:
  _target_: diffusion_policy_3d.env_runner.metaworld_runner.MetaworldRunner
  n_train: 0              # 不用于训练
  n_test: 20              # 评估时运行20个episode（提高统计可靠性）
  max_steps: 200          # 每个episode最大步数
  eval_episodes: 20       # 总评估episode数
  fps: 10                 # 视频帧率（如果保存视频）
  task_name: ${task.env_name}
  device: ${training.device}
  use_point_crop: true    # 启用点云裁剪

# ============================================
# 3. 数据集配置
# ============================================
dataset:
  _target_: diffusion_policy_3d.dataset.offline_dataset.OfflineRLDataset

  # ----------------------------------------
  # 数据路径
  # ----------------------------------------
  zarr_path: data/metaworld_wrapper_data
  # 说明：这是相对路径，Hydra会自动转为绝对路径
  # 如果数据在其他位置，修改此路径

  # ----------------------------------------
  # 序列采样参数
  # ----------------------------------------
  horizon: 16             # 序列长度（需与policy保持一致）
  pad_before: 1           # (n_obs_steps - 1) = 2 - 1 = 1
  pad_after: 7            # (n_action_steps - 1) = 8 - 1 = 7

  # ----------------------------------------
  # 数据集分割
  # ----------------------------------------
  seed: 42                # 随机种子
  val_ratio: 0.05         # 验证集比例（5%）
  max_train_episodes: null  # 不限制训练episode数（使用全部数据）
  # 如果数据量很大，可以设置max_train_episodes: 1000

  # ----------------------------------------
  # RL数据集特有参数
  # ----------------------------------------
  task_type: metaworld     # 任务类型
  reward_type: sparse    # 奖励类型: distance | sparse
  # distance: 连续的负距离奖励（推荐，学习更容易）
  # sparse: 只有达到目标才给1（更难但更符合任务定义）

  target_pos: null         # 目标位置（null表示从环境state读取）

  # ----------------------------------------
  # MetaWorld特定配置
  # ----------------------------------------
  full_state_dim: 39       # MetaWorld完整状态维度

  # ----------------------------------------
  # 数据增强
  # ----------------------------------------
  augment_pc: true         # 启用点云增强
  # 增强方式：
  # - 随机旋转: X/Y轴 ±10°, Z轴 ±15°
  # - 随机平移: ±0.01m
  # 作用：提高策略对点云噪声的鲁棒性

  # ----------------------------------------
  # 点云变换（与采集时保持一致）
  # ----------------------------------------
  pc_transform: null       # null表示在wrapper中已处理
  pc_scale: [1, 1, 1]      # 不缩放
  pc_offset: [0, 0, 0]     # 不偏移

  # ----------------------------------------
  # PointNet编码器配置
  # ----------------------------------------
  pointcloud_encoder_cfg:
    in_channels: 3         # 输入通道（XYZ）
    out_channels: 256      # 输出特征维度
    use_layernorm: true    # 使用LayerNorm（稳定训练）
    final_norm: none       # 最后一层不用归一化
    use_projection: true   # 使用特征投影
    in_channels_points: 1024  # 输入点数

# ============================================
# 任务特定说明
# ============================================
# Button Press任务：
# - 目标: 机械臂末端按下按钮
# - 难度: 中等
# - 成功标准: 按钮被按下
# - 奖励: distance模式下为负的末端到按钮距离
#
# 数据集要求：
# - 最少: 10个成功演示（~2000步）
# - 推荐: 50个演示（~10000步）
# - 充足: 100+个演示（~20000步）
#
# 预期性能（使用distance reward）：
# - IL阶段结束: 30-50% 成功率
# - 离线RL结束: 60-80% 成功率
# - 在线RL结束: 70-90% 成功率
#
# 如果使用sparse reward：
# - 学习曲线会更慢
# - 需要更多数据和更长训练时间
# - 最终性能可能略低（60-80%）
